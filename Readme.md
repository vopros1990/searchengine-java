# Search Engine Java

Данное приложение является полноценным поисковым движком для индексации веб сайтов.    
Код написан на Java с использованием Spring Boot Framework.

### Что умеет данное веб приложение:
- Выполняет обход страниц сайтов, указанных в конфигурационном файле (см. [Конфигурация](#конфигурация))
- Создает поисковые индексы всех найденных страниц
- Создает поисковый индекс для отдельной страницы
- Показывает общую статистику индексации
- Предоставляет возможность поиска по страницам проиндексированных сайтов
- После запуска доступен небольшой FRONT-END (на локальной машине - http://localhost:8080/)
____
## Навигация
- [Системные требования](#системные-требования)
- [API команды](#api-команды)
    - [Индексация](#индексация)
    - [Статистика](#статистика)
    - [Поиск](#поиск)
- [Конфигурация](#конфигурация)
    - [Подключение базы данных](#подключение-базы-данных)
    - [Добавление сайта в список для индексации](#добавление-сайта-в-список-для-индексации)
    - [Настройка модуля обхода страниц](#настройка-модуля-обхода-страниц)
    - [Настройка выполнения многопоточных задач](#настройка-выполнения-многопоточных-задач)
- [Особенности разработки приложения](#особенности-разработки-приложения)
- [Благодарности](#благодарности)
____
## Системные требования

- JDK v17+ *
- PostgreSQL
- Модуль Lucene Morphology (см. [Подключение модуля Lucene Morphology](#подключение-модуля-lucene-morphology))

_Более ранние версии не тестировались_    
#### ⬆️  [НАВЕРХ](#search-engine-java)
____

## API команды

### ИНДЕКСАЦИЯ

#### Запуск полной индексации сайтов, указанных в конфигурационном файле

`GET /api/startIndexing`

```java
/* ФОРМАТ ОТВЕТА */

{
  'result': true, //в случае успешного запуска
  'error': "error message" //сообщениие об ошибке в случае, если result: false
}
```

#### Остановка индексации всех сайтов:

`GET /api/stopIndexing`
```java
/* ФОРМАТ ОТВЕТА */

{
  'result': true, //в случае успешного запуска
  'error': "error message" //сообщениие об ошибке в случае, если result: false
}
```
#### Запуск индексации отдельной страницы сайта из числа указанных в конфигурационном файле

`POST /api/indexPage`

```java
/* ПАРАМЕТРЫ POST ЗАПРОСА */

{
  'url': "https://example.com/site-page/" //адрес страницы
}

/* ФОРМАТ ОТВЕТА */

{
  'result': true, //в случае успешного запуска
  'error': "error message" //сообщениие об ошибке в случае, если result: false
}
```

### СТАТИСТИКА

#### Получения информации о созданных поисковых индексах и состоянии поискового движка</h4>

`GET /api/statistics`

```java
/* ФОРМАТ ОТВЕТА В СЛУЧАЕ УСПЕХА */

{
  'result': true,
  'statistics': {
    "total": {
      "sites": 10,
      "pages": 436423,
      "lemmas": 5127891,
      "indexing": true
    },
    "detailed": [
      {
        "url": "http://www.example.com/",
        "name": "Имя сайта",
        "status": "INDEXED", // INDEXING, INDEXED, FAILED
        "statusTime": 1600160357,
        "error": "error message",
        "pages": 5764,
        "lemmas": 321115
      },
      ...
    ]
}
```

### ПОИСК
#### Поиск по страницам проиндексированных сайтов
`GET /api/search?{params}`

#### Параметры запроса:
- **query** — поисковый запрос;
- **site** — сайт, по которому осуществлять поиск. Если не указать, поиск будет выполнен по страницам всех проиндексированных сайтов;
- **offset** — сдвиг от 0 для постраничного вывода (необязательный параметр, значение по-умолчанию 0);
- **limit** — количество результатов, которое необходимо вывести (необязательный параметр, значение по-умолчанию 20).

```java
/* ФОРМАТ ОТВЕТА В СЛУЧАЕ УСПЕХА */

{
  'result': true,
  'statistics': {
    "total": {
      "sites": 10,
      "pages": 436423,
      "lemmas": 5127891,
      "indexing": true
    },
    "detailed": [
      {
        "url": "http://www.example.com/",
        "name": "Имя сайта",
        "status": "INDEXED", // INDEXING, INDEXED, FAILED
        "statusTime": 1600160357,
        "error": "error message",
        "pages": 5764,
        "lemmas": 321115
      },
      ...
    ]
}

/* ФОРМАТ ОТВЕТА В СЛУЧАЕ ОШИБКИ */

{
  'result': false,
  'error': "error message" //сообщениие об ошибке
}
```    
#### ⬆️  [НАВЕРХ](#search-engine-java)
____
## Конфигурация
Для настройки программы отредактируйте файл
`src/main/resources/application.yaml`
### Подключение базы данных
* *Введите имя базы данных PostgreSQL, имя пользователя и пароль в соответствующие поля* *

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/search_engine
    username: postgres
    password: 12345678
    driver-class-name: org.postgresql.Driver
```
### Добавление сайта в список для индексации
_Адрес сайта в формате **https://example.com**_.    
_Если нужно включить в индекс только страницы из определенной "точки входа",
можно указать url в следующем формате: **https://example.com/entry_point_path**_

```yaml
indexing-settings:
  sites:
    - url: адрес_сайта
      name: название сайта
```

### Настройка модуля обхода страниц

```yaml
crawler-settings:
  headers-rotation-interval-seconds: 300 # периодичность смены заголовков в секундах (параметр headers)
  connection-timeout-millis-min: 300 # таймаут подключения в миллисекундах, минимальное значение
  connection-timeout-millis-max: 2500 # таймаут подключения в миллисекундах, максимальное значение
  page-load-time-limit-millis: 15000 # лимит времени загрузки страницы в миллисекундах
  reconnect-attempts-max: 10 # количество попыток повторного соединения
  reconnect-attempt-timeout-millis: 5000 # таймаут между попытками повторного соединения
  headers: # добавьте собственные хедеры по образцу ниже
    - user-agent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 YaBrowser/25.8.0.0 Safari/537.36"
      referrer: "http://www.google.com"
      accept: "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,/;q=0.8"
      accept-language: "ru-RU,ru;q=0.9"
      accept-encoding: "gzip, deflate, br"
      upgrade-insecure-requests: "1"
```
### Настройка выполнения многопоточных задач

```yaml
task-executor:
  shutdown-await-termination-seconds: 15 # таймаут перед остановкой многопоточных процессов (например, процесса индексации), в секундах
```

____
## Особенности разработки приложения
### Модуль лемматзации

Программа использует технологию приведения слов к их 
морфологической базовой форме - лемме. Для работы данной функции требуется подключить библиотеку
**Lucene Morphology**.

Данное решение достаточно требовательно к ресурсам сервера - оперативной памяти и CPU.
Поэтому, во время индексации сайтов все данные модуля лемматизатора кешируются в оперативной памяти, 
а также сохраняется в базе данных. При перезапуске приложения кеш загружается
обратно в оперативную память.

### Поисковый запрос
Коротко скажу лишь о том, что испытываю гордость и удовлетворение за
то, что вся поисковая выдача формируется лишь одним сложным нативным SQL запросом, что сильно экономит время формирования выдачи и ресурсы памяти. Реализацию можно посмотреть
в PageRepository пакета `src/repositories`.

### Модуль формирования сниппета найденной страницы

Немало времени заняла работа над формированием короткой выдержки из
текста страницы с подсветкой поисковых слов. Алгоритм основан на том, что сначала в основную
морфологическую форму переводятся слова поисковой фразы и текст проиндексированной страницы. Далее осуществляется поиск
 вхождений каждого слова в тексте.
Из массивов индексов найденных слов формируются своеобразные "области" контента (Content Range). 
Большие области разбиваются на более мелкие. Вокруг каждой области формируется контекст из определенного количества слов.
Самые релевантные запросу сниппеты ставятся вначале поисковой выдачи.    
#### ⬆️  [НАВЕРХ](#search-engine-java)
____
## Благодарности
Я бы хотел поблагодарить за этот прекрасный опыт команду `Skillbox`, 
всех моих кураторов, которые проверяли практические работы и давали наставления.
Огромная благодарность за возможность реализовать свой первый достаточно объемный проект,
за опыт и положительные эмоции, полученные в процессе обучения!    
#### ⬆️  [НАВЕРХ](#search-engine-java)
